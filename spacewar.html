<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space War - Raptor Style</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: #000; color: #fff; overflow: hidden;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        #ui {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 20px; pointer-events: none; z-index: 10;
        }
        .stat-bar {
            background: rgba(0,0,0,0.8); border: 2px solid #00ffff;
            border-radius: 10px; padding: 10px;
            display: inline-block; margin-right: 20px;
            box-shadow: 0 0 15px rgba(0,255,255,0.3);
        }
        .stat-label { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .bar {
            width: 200px; height: 20px; background: #333;
            border-radius: 5px; overflow: hidden; border: 1px solid #666;
        }
        .bar-fill {
            height: 100%; transition: width 0.3s;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }
        .exp-bar .bar-fill {
            background: linear-gradient(90deg, #ffff00, #ff9900);
            box-shadow: 0 0 10px rgba(255,255,0,0.5);
        }
        #levelUpModal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 3px solid #00ffff;
            border-radius: 15px; padding: 30px; display: none;
            z-index: 100; max-width: 1000px; pointer-events: auto;
            box-shadow: 0 0 40px rgba(0,255,255,0.6);
        }
        .upgrade-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 15px; margin-top: 20px;
        }
        .upgrade-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ffff; border-radius: 10px;
            padding: 15px; cursor: pointer; transition: all 0.3s;
        }
        .upgrade-card:hover {
            transform: scale(1.05); border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }
        .upgrade-icon { font-size: 32px; margin-bottom: 8px; }
        .upgrade-name {
            color: #00ffff; font-size: 15px;
            font-weight: bold; margin-bottom: 8px;
        }
        .upgrade-desc { color: #aaa; font-size: 12px; }
        .level-display { color: #ffff00; font-size: 13px; margin-top: 8px; }
        #gameOver {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 3px solid #ff0000;
            border-radius: 15px; padding: 40px; display: none;
            z-index: 100; text-align: center;
            box-shadow: 0 0 40px rgba(255,0,0,0.6);
        }
        .btn {
            background: linear-gradient(135deg, #00ffff, #0099ff);
            border: none; color: #000; padding: 15px 30px;
            font-size: 18px; font-weight: bold; border-radius: 10px;
            cursor: pointer; margin: 10px; transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0,255,255,0.8);
        }
        #stats {
            position: fixed; top: 80px; left: 20px;
            background: rgba(0,0,0,0.8); border: 2px solid #00ffff;
            border-radius: 10px; padding: 15px; font-size: 14px; color: #0ff;
            box-shadow: 0 0 15px rgba(0,255,255,0.3);
        }
        canvas {
            image-rendering: pixelated !important;
            image-rendering: crisp-edges !important;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <div id="ui">
        <div class="stat-bar">
            <div class="stat-label">HP: <span id="hpText">150/150</span></div>
            <div class="bar"><div class="bar-fill" id="hpBar" style="width: 100%"></div></div>
        </div>
        <div class="stat-bar exp-bar">
            <div class="stat-label">Í≤ΩÌóòÏπò: <span id="expText">0/100</span></div>
            <div class="bar"><div class="bar-fill" id="expBar" style="width: 0%"></div></div>
        </div>
    </div>
    
    <div id="stats">
        <div>Î†àÎ≤®: <span id="levelText">1</span></div>
        <div>ÏãúÍ∞Ñ: <span id="timeText">00:00</span></div>
        <div>Ï≤òÏπò: <span id="killText">0</span></div>
    </div>
    
    <div id="levelUpModal">
        <h2 style="color: #00ffff; text-align: center; margin-bottom: 20px;">‚¨ÜÔ∏è Î†àÎ≤® UP! ÏóÖÍ∑∏Î†àÏù¥Îìú ÏÑ†ÌÉù</h2>
        <div class="upgrade-grid" id="upgradeOptions"></div>
    </div>
    
    <div id="gameOver">
        <h1 style="color: #ff0000; margin-bottom: 20px;">üí• Ï†ÑÌï® ÌååÍ¥¥!</h1>
        <div style="font-size: 24px; margin-bottom: 20px;">
            <div>ÏÉùÏ°¥ ÏãúÍ∞Ñ: <span id="finalTime" style="color: #ffff00;">00:00</span></div>
            <div>Ï¥ù Ï≤òÏπò: <span id="finalKills" style="color: #00ff00;">0</span></div>
            <div>ÏµúÏ¢Ö Î†àÎ≤®: <span id="finalLevel" style="color: #00ffff;">1</span></div>
        </div>
        <button class="btn" onclick="location.reload()">üîÑ Îã§Ïãú ÏãúÏûë</button>
    </div>

    <script>
        // === Phaser Scene ===
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
            }

            preload() {
                // ÌîΩÏÖÄ ÏïÑÌä∏ Ïä§ÌÉÄÏùº ÌÖçÏä§Ï≤ò ÏÉùÏÑ±
                this.createPlayerTexture();
                this.createEnemyTextures();
                this.createProjectileTextures();
                this.createExplosionTextures();
            }

            createPlayerTexture() {
                // Raptor Ïä§ÌÉÄÏùº Ï†ÑÌà¨Í∏∞
                const g = this.add.graphics();
                
                // ÏÑ†Ï≤¥ (Í∏àÏÜç Í∑∏ÎùºÎç∞Ïù¥ÏÖò)
                g.fillStyle(0x2a4a7a);
                g.fillRect(16, 2, 8, 36);
                
                // ÌïòÏù¥ÎùºÏù¥Ìä∏
                g.fillStyle(0x4a7abc);
                g.fillRect(17, 3, 2, 34);
                
                // Ïñ¥ÎëêÏö¥ Î∂ÄÎ∂Ñ
                g.fillStyle(0x1a2a4a);
                g.fillRect(22, 3, 2, 34);
                
                // ÎÇ†Í∞ú
                g.fillStyle(0x3a5a8a);
                g.fillTriangle(4, 20, 16, 15, 16, 25);
                g.fillTriangle(24, 15, 36, 20, 24, 25);
                
                // ÎÇ†Í∞ú ÌïòÏù¥ÎùºÏù¥Ìä∏
                g.fillStyle(0x5a8aca);
                g.fillTriangle(6, 20, 16, 16, 16, 24);
                g.fillTriangle(24, 16, 34, 20, 24, 24);
                
                // Ï°∞Ï¢ÖÏÑù (Ïú†Î¶¨)
                g.fillStyle(0x6ac8ff);
                g.fillRect(18, 6, 4, 6);
                g.fillStyle(0x4aa8df);
                g.fillRect(18, 6, 2, 6);
                
                // ÏóîÏßÑ (Îπ®Í∞ï)
                g.fillStyle(0xff4400);
                g.fillRect(16, 32, 3, 4);
                g.fillRect(21, 32, 3, 4);
                
                // ÏóîÏßÑ ÌïòÏù¥ÎùºÏù¥Ìä∏
                g.fillStyle(0xff8844);
                g.fillRect(16, 32, 1, 4);
                g.fillRect(21, 32, 1, 4);
                
                // Î¨¥Í∏∞ Ìè¨Ìä∏
                g.fillStyle(0x8a8a8a);
                g.fillRect(12, 18, 2, 4);
                g.fillRect(26, 18, 2, 4);
                
                g.generateTexture('player', 40, 40);
                g.destroy();
            }

            createEnemyTextures() {
                // Ï†Å ÌÉÄÏûÖ 1: Ï†ÑÌà¨Í∏∞
                let g = this.add.graphics();
                g.fillStyle(0xff3333);
                g.fillRect(12, 4, 16, 24);
                g.fillStyle(0xaa0000);
                g.fillRect(14, 6, 12, 20);
                g.fillStyle(0xff6666);
                g.fillRect(13, 5, 2, 22);
                // ÎÇ†Í∞ú
                g.fillStyle(0xcc2222);
                g.fillTriangle(4, 16, 12, 12, 12, 20);
                g.fillTriangle(28, 12, 36, 16, 28, 20);
                g.generateTexture('enemy1', 40, 32);
                g.destroy();
                
                // Ï†Å ÌÉÄÏûÖ 2: Ï§ëÌòï
                g = this.add.graphics();
                g.fillStyle(0xff6600);
                g.fillRect(10, 6, 20, 20);
                g.fillStyle(0xaa4400);
                g.fillRect(12, 8, 16, 16);
                g.fillStyle(0xff9944);
                g.fillRect(11, 7, 3, 18);
                g.fillRect(8, 12, 4, 8);
                g.fillRect(28, 12, 4, 8);
                g.generateTexture('enemy2', 40, 32);
                g.destroy();
                
                // Ï†Å ÌÉÄÏûÖ 3: ÎåÄÌòï
                g = this.add.graphics();
                g.fillStyle(0xaa00aa);
                g.fillRect(8, 4, 24, 28);
                g.fillStyle(0x660066);
                g.fillRect(10, 6, 20, 24);
                g.fillStyle(0xdd44dd);
                g.fillRect(9, 5, 4, 26);
                // ÌÑ∞Î†õ
                g.fillStyle(0xff00ff);
                g.fillCircle(12, 12, 3);
                g.fillCircle(28, 12, 3);
                g.fillCircle(12, 24, 3);
                g.fillCircle(28, 24, 3);
                g.generateTexture('enemy3', 40, 36);
                g.destroy();
            }

            createProjectileTextures() {
                // Î†àÏù¥Ï†Ä
                let g = this.add.graphics();
                g.fillStyle(0x00ffff);
                g.fillRect(0, 0, 2, 8);
                g.fillStyle(0xffffff);
                g.fillRect(0, 2, 2, 4);
                g.generateTexture('laser', 2, 8);
                g.destroy();
                
                // ÎØ∏ÏÇ¨Ïùº
                g = this.add.graphics();
                g.fillStyle(0xff6600);
                g.fillRect(0, 0, 3, 10);
                g.fillStyle(0xff9944);
                g.fillRect(0, 0, 1, 10);
                g.fillStyle(0xcccccc);
                g.fillRect(0, 8, 3, 2);
                g.generateTexture('missile', 3, 10);
                g.destroy();
                
                // ÌîåÎùºÏ¶àÎßà
                g = this.add.graphics();
                g.fillStyle(0xff00ff);
                g.fillCircle(6, 6, 6);
                g.fillStyle(0xff88ff);
                g.fillCircle(6, 6, 4);
                g.fillStyle(0xffffff);
                g.fillCircle(6, 6, 2);
                g.generateTexture('plasma', 12, 12);
                g.destroy();
            }

            createExplosionTextures() {
                // Ìè≠Î∞ú ÌîÑÎ†àÏûÑ (4Í∞ú)
                for (let i = 0; i < 4; i++) {
                    const g = this.add.graphics();
                    const size = 8 + i * 8;
                    const alpha = 1 - i * 0.2;
                    
                    g.fillStyle(0xff6600, alpha);
                    g.fillCircle(16, 16, size);
                    g.fillStyle(0xffaa44, alpha * 0.8);
                    g.fillCircle(16, 16, size * 0.7);
                    g.fillStyle(0xffff88, alpha * 0.6);
                    g.fillCircle(16, 16, size * 0.4);
                    
                    g.generateTexture('explosion' + i, 32, 32);
                    g.destroy();
                }
            }

            create() {
                this.initGame();
                
                // Î∞∞Í≤Ω (Ïä§ÌÅ¨Î°§ Î≥Ñ)
                this.stars = [];
                for (let i = 0; i < 200; i++) {
                    const star = this.add.circle(
                        Phaser.Math.Between(0, config.width),
                        Phaser.Math.Between(0, config.height),
                        Phaser.Math.Between(1, 2),
                        0xffffff,
                        Phaser.Math.FloatBetween(0.3, 0.8)
                    );
                    star.setData('speed', Phaser.Math.Between(20, 100));
                    this.stars.push(star);
                }
                
                // ÌîåÎ†àÏù¥Ïñ¥
                this.player = this.add.sprite(config.width / 2, config.height / 2, 'player');
                this.player.setScale(1.5);
                
                // ÏóîÏßÑ ÌååÌã∞ÌÅ¥
                this.engineFire = this.add.particles(0, 0, 'particle', {
                    speed: { min: 50, max: 100 },
                    scale: { start: 0.4, end: 0 },
                    tint: [0xff4400, 0xff8844, 0xffaa44],
                    lifespan: 200,
                    frequency: 20,
                    x: config.width / 2,
                    y: config.height / 2 + 30
                });
                
                this.enemies = this.add.group();
                this.projectiles = this.add.group();
                this.explosions = this.add.group();
                
                // ÌÉÄÏù¥Î®∏
                this.time.addEvent({
                    delay: 1000,
                    callback: () => {
                        if (!this.gamePaused) {
                            this.gameTime++;
                            updateUI();
                        }
                    },
                    loop: true
                });
                
                this.spawnTimer = 0;
            }

            // ÌÖçÏä§Ï≤ò ÏÉùÏÑ± ÌõÑ ÌååÌã∞ÌÅ¥Ïö©
            preload() {
                this.createPlayerTexture();
                this.createEnemyTextures();
                this.createProjectileTextures();
                this.createExplosionTextures();
                
                // ÌååÌã∞ÌÅ¥Ïö©
                const g = this.add.graphics();
                g.fillStyle(0xffffff);
                g.fillCircle(4, 4, 4);
                g.generateTexture('particle', 8, 8);
                g.destroy();
            }

            initGame() {
                this.gameRunning = true;
                this.gamePaused = false;
                this.gameTime = 0;
                this.kills = 0;
                
                this.playerData = {
                    hp: 150,
                    maxHp: 150,
                    level: 1,
                    exp: 0,
                    expToNext: 100
                };
                
                this.weapons = [{ type: 'laser', lastShot: 0 }];
                this.weaponTypes = createWeaponTypes(this);
            }

            update(time, delta) {
                if (!this.gameRunning || this.gamePaused) return;
                
                const deltaTime = delta / 1000;
                
                // Î≥Ñ Ïä§ÌÅ¨Î°§
                this.stars.forEach(star => {
                    star.y += star.getData('speed') * deltaTime;
                    if (star.y > config.height) {
                        star.y = 0;
                        star.x = Phaser.Math.Between(0, config.width);
                    }
                });
                
                // Î¨¥Í∏∞ Î∞úÏÇ¨
                this.weapons.forEach(weapon => {
                    const wData = this.weaponTypes[weapon.type];
                    if (wData.shoot && time - weapon.lastShot > wData.cooldown) {
                        wData.shoot(this, time);
                        weapon.lastShot = time;
                    }
                });
                
                // Î∞úÏÇ¨Ï≤¥ ÏóÖÎç∞Ïù¥Ìä∏
                this.projectiles.getChildren().forEach(proj => {
                    const data = proj.getData('data');
                    
                    if (data.life !== undefined) {
                        data.life--;
                        if (data.life <= 0) {
                            proj.destroy();
                            return;
                        }
                    }
                    
                    // Ïú†ÎèÑ ÎØ∏ÏÇ¨Ïùº
                    if (data.type === 'missile' && data.target && data.target.active) {
                        const angle = Phaser.Math.Angle.Between(
                            proj.x, proj.y, data.target.x, data.target.y
                        );
                        proj.setVelocity(
                            Math.cos(angle) * 300,
                            Math.sin(angle) * 300
                        );
                        proj.setRotation(angle + Math.PI / 2);
                    }
                    
                    // ÌôîÎ©¥ Î∞ñ Ï†úÍ±∞
                    if (proj.y < -50 || proj.y > config.height + 50 ||
                        proj.x < -50 || proj.x > config.width + 50) {
                        proj.destroy();
                    }
                });
                
                // Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
                this.enemies.getChildren().forEach(enemy => {
                    const data = enemy.getData('data');
                    
                    // ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÏ†Å
                    this.physics.moveToObject(enemy, this.player, data.speed);
                    
                    // Ï∂©Îèå Ï≤¥ÌÅ¨ (ÌîåÎ†àÏù¥Ïñ¥)
                    const dist = Phaser.Math.Distance.Between(
                        enemy.x, enemy.y, this.player.x, this.player.y
                    );
                    if (dist < 40) {
                        this.playerData.hp -= data.damage;
                        this.createExplosion(enemy.x, enemy.y);
                        this.cameras.main.shake(100, 0.01);
                        enemy.destroy();
                        
                        if (this.playerData.hp <= 0) {
                            this.gameOver();
                        }
                    }
                    
                    // Ï∂©Îèå Ï≤¥ÌÅ¨ (Î∞úÏÇ¨Ï≤¥)
                    this.projectiles.getChildren().forEach(proj => {
                        const pdist = Phaser.Math.Distance.Between(
                            proj.x, proj.y, enemy.x, enemy.y
                        );
                        if (pdist < 25) {
                            const projData = proj.getData('data');
                            const damage = projData.damage * (1 + this.weaponTypes.damage.level * 0.1);
                            data.hp -= damage;
                            
                            this.createHitEffect(enemy.x, enemy.y);
                            proj.destroy();
                            
                            if (data.hp <= 0) {
                                this.kills++;
                                this.createExplosion(enemy.x, enemy.y);
                                enemy.destroy();
                                
                                this.playerData.exp += 10;
                                if (this.playerData.exp >= this.playerData.expToNext) {
                                    this.levelUp();
                                }
                            }
                        }
                    });
                });
                
                // Ï†Å Ïä§Ìè∞
                const spawnRate = Math.max(300 - this.gameTime * 8, 100);
                this.spawnTimer += delta;
                if (this.spawnTimer > spawnRate) {
                    this.spawnEnemy();
                    this.spawnTimer = 0;
                }
                
                updateUI();
            }

            spawnEnemy() {
                const side = Phaser.Math.Between(0, 3);
                let x, y;
                
                switch(side) {
                    case 0: x = Phaser.Math.Between(0, config.width); y = -50; break;
                    case 1: x = config.width + 50; y = Phaser.Math.Between(0, config.height); break;
                    case 2: x = Phaser.Math.Between(0, config.width); y = config.height + 50; break;
                    case 3: x = -50; y = Phaser.Math.Between(0, config.height); break;
                }
                
                const difficulty = 1 + this.gameTime / 60;
                const type = Phaser.Math.Between(0, 2);
                const textures = ['enemy1', 'enemy2', 'enemy3'];
                
                const enemy = this.add.sprite(x, y, textures[type]);
                this.physics.add.existing(enemy);
                this.enemies.add(enemy);
                
                const hpMult = type === 0 ? 1 : type === 1 ? 1.5 : 2.5;
                const speedMult = type === 0 ? 1.2 : type === 1 ? 1 : 0.7;
                
                enemy.setData('data', {
                    hp: 25 * difficulty * hpMult,
                    maxHp: 25 * difficulty * hpMult,
                    speed: 80 * Math.min(difficulty, 2) * speedMult,
                    damage: 3 + type
                });
            }

            createExplosion(x, y) {
                const explosion = this.add.sprite(x, y, 'explosion0');
                explosion.setScale(1.5);
                
                const anim = this.tweens.createTimeline();
                for (let i = 0; i < 4; i++) {
                    anim.add({
                        targets: explosion,
                        duration: 50,
                        onStart: () => explosion.setTexture('explosion' + i)
                    });
                }
                anim.add({
                    targets: explosion,
                    alpha: 0,
                    duration: 100,
                    onComplete: () => explosion.destroy()
                });
                anim.play();
            }

            createHitEffect(x, y) {
                const flash = this.add.circle(x, y, 10, 0xffffff, 0.8);
                this.tweens.add({
                    targets: flash,
                    scale: 2,
                    alpha: 0,
                    duration: 150,
                    onComplete: () => flash.destroy()
                });
            }

            levelUp() {
                this.playerData.level++;
                this.playerData.exp -= this.playerData.expToNext;
                this.playerData.expToNext = Math.floor(this.playerData.expToNext * 1.2);
                this.gamePaused = true;
                showLevelUp(this);
            }

            gameOver() {
                this.gameRunning = false;
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = this.gameTime % 60;
                document.getElementById('finalTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('finalKills').textContent = this.kills;
                document.getElementById('finalLevel').textContent = this.playerData.level;
                document.getElementById('gameOver').style.display = 'block';
            }
        }

        const config = {
            type: Phaser.WEBGL,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game-container',
            backgroundColor: '#0a0a1a',
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 0 }, debug: false }
            },
            scene: GameScene
        };

        const phaserGame = new Phaser.Game(config);
        let currentScene;

        // Î¨¥Í∏∞ ÏãúÏä§ÌÖú (ÏõêÎûò Î°úÏßÅ Ïú†ÏßÄ)
        function createWeaponTypes(scene) {
            return {
                laser: {
                    name: 'Î†àÏù¥Ï†Ä Ìè¨', icon: 'üî´', desc: 'Ï†ÑÎ∞©ÏúÑ Î†àÏù¥Ï†Ä',
                    damage: 10, cooldown: 250, level: 1, maxLevel: 8,
                    shoot: (scene, time) => {
                        const count = 2 + scene.weaponTypes.laser.level;
                        for (let i = 0; i < count; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const proj = scene.add.sprite(scene.player.x, scene.player.y, 'laser');
                            scene.physics.add.existing(proj);
                            proj.body.setVelocity(
                                Math.cos(angle) * 400,
                                Math.sin(angle) * 400
                            );
                            proj.setRotation(angle);
                            proj.setData('data', {
                                damage: scene.weaponTypes.laser.damage * (1 + scene.weaponTypes.laser.level * 0.5),
                                type: 'laser'
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                missile: {
                    name: 'Ïú†ÎèÑ ÎØ∏ÏÇ¨Ïùº', icon: 'üöÄ', desc: 'Ï†Å Ï∂îÏ†Å ÎØ∏ÏÇ¨Ïùº',
                    damage: 25, cooldown: 1000, level: 0, maxLevel: 6,
                    shoot: (scene, time) => {
                        if (scene.enemies.getLength() === 0) return;
                        const count = 1 + Math.floor(scene.weaponTypes.missile.level / 2);
                        const enemies = scene.enemies.getChildren();
                        for (let i = 0; i < Math.min(count, enemies.length); i++) {
                            const target = enemies[i];
                            const proj = scene.add.sprite(scene.player.x, scene.player.y, 'missile');
                            scene.physics.add.existing(proj);
                            proj.setData('data', {
                                damage: scene.weaponTypes.missile.damage * (1 + scene.weaponTypes.missile.level * 0.4),
                                type: 'missile',
                                target: target
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                plasma: {
                    name: 'ÌîåÎùºÏ¶àÎßà Î≥º', icon: 'üí•', desc: 'Î∞©ÏÇ¨Ìòï ÌîåÎùºÏ¶àÎßà',
                    damage: 15, cooldown: 800, level: 0, maxLevel: 6,
                    shoot: (scene, time) => {
                        const count = 4 + scene.weaponTypes.plasma.level * 2;
                        for (let i = 0; i < count; i++) {
                            const angle = (Math.PI * 2 / count) * i;
                            const proj = scene.add.sprite(scene.player.x, scene.player.y, 'plasma');
                            scene.physics.add.existing(proj);
                            proj.body.setVelocity(
                                Math.cos(angle) * 300,
                                Math.sin(angle) * 300
                            );
                            proj.setData('data', {
                                damage: scene.weaponTypes.plasma.damage * (1 + scene.weaponTypes.plasma.level * 0.3),
                                type: 'plasma'
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                shield: {
                    name: 'ÏóêÎÑàÏßÄ Ïã§Îìú', icon: 'üõ°Ô∏è', desc: 'ÏµúÎåÄ Ï≤¥Î†• +30',
                    level: 0, maxLevel: 8,
                    apply: (scene) => {
                        scene.playerData.maxHp += 30;
                        scene.playerData.hp = Math.min(scene.playerData.hp + 30, scene.playerData.maxHp);
                    }
                },
                regen: {
                    name: 'Ïû¨ÏÉù', icon: 'üíö', desc: 'Ï≤¥Î†• ÌöåÎ≥µ +20',
                    level: 0, maxLevel: 10,
                    apply: (scene) => {
                        scene.playerData.hp = Math.min(scene.playerData.hp + 20, scene.playerData.maxHp);
                    }
                },
                damage: {
                    name: 'ÌôîÎ†• Ï¶ùÍ∞ï', icon: 'üí™', desc: 'Î™®Îì† Î¨¥Í∏∞ +10%',
                    level: 0, maxLevel: 15,
                    apply: (scene) => {}
                }
            };
        }

        function showLevelUp(scene) {
            if (!currentScene) currentScene = scene;
            const modal = document.getElementById('levelUpModal');
            const options = document.getElementById('upgradeOptions');
            options.innerHTML = '';
            
            const available = Object.keys(scene.weaponTypes).filter(k => {
                const w = scene.weaponTypes[k];
                return !w.maxLevel || w.level < w.maxLevel;
            });
            
            const selected = [];
            while (selected.length < Math.min(5, available.length)) {
                const idx = Math.floor(Math.random() * available.length);
                selected.push(available[idx]);
                available.splice(idx, 1);
            }
            
            selected.forEach(key => {
                const weapon = scene.weaponTypes[key];
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <div class="upgrade-icon">${weapon.icon}</div>
                    <div class="upgrade-name">${weapon.name}</div>
                    <div class="upgrade-desc">${weapon.desc}</div>
                    <div class="level-display">Lv ${weapon.level} ‚Üí ${weapon.level + 1}</div>
                `;
                card.onclick = () => selectUpgrade(scene, key);
                options.appendChild(card);
            });
            
            modal.style.display = 'block';
        }

        function selectUpgrade(scene, key) {
            const weapon = scene.weaponTypes[key];
            weapon.level++;
            
            if (weapon.shoot && !scene.weapons.find(w => w.type === key)) {
                scene.weapons.push({ type: key, lastShot: 0 });
            }
            
            if (weapon.apply) {
                weapon.apply(scene);
            }
            
            document.getElementById('levelUpModal').style.display = 'none';
            scene.gamePaused = false;
        }

        function updateUI() {
            if (!currentScene) currentScene = phaserGame.scene.scenes[0];
            const p = currentScene.playerData;
            
            document.getElementById('hpText').textContent = `${Math.ceil(p.hp)}/${p.maxHp}`;
            document.getElementById('hpBar').style.width = (p.hp / p.maxHp * 100) + '%';
            document.getElementById('expText').textContent = `${p.exp}/${p.expToNext}`;
            document.getElementById('expBar').style.width = (p.exp / p.expToNext * 100) + '%';
            document.getElementById('levelText').textContent = p.level;
            document.getElementById('killText').textContent = currentScene.kills;
            
            const minutes = Math.floor(currentScene.gameTime / 60);
            const seconds = currentScene.gameTime % 60;
            document.getElementById('timeText').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        window.addEventListener('resize', () => {
            phaserGame.scale.resize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>